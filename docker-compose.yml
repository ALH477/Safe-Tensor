version: '3.8'

services:
  shim:
    image: alh477/dcf-shim:latest
    network_mode: host
    environment:
      - SHIM_INGRESS_PORT=9999
      - SHIM_NODE_TARGET=127.0.0.1:7777

  head:
    image: demod/mesh-head:latest
    network_mode: host

  # NVIDIA Worker
  worker-nvidia:
    image: alh477/mesh-worker-nvidia:latest
    network_mode: host
    command: ["python3", "/bin/worker_node.py", "--head-ip", "127.0.0.1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ./model-cache:/data/huggingface

  # AMD ROCm Worker
  worker-rocm:
    image: alh477/mesh-worker-rocm:latest
    network_mode: host
    command: ["python3", "/bin/worker_node.py", "--head-ip", "127.0.0.1"]
    # ROCm requires access to KFD and Render devices
    devices:
      - /dev/kfd
      - /dev/dri
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - HSA_OVERRIDE_GFX_VERSION=10.3.0 # Example for RDNA2
    volumes:
      - ./model-cache:/data/huggingface
