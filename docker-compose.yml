version: '3.8'

services:
  # Official DCF Bridge (Ingress)
  shim:
    image: alh477/dcf-shim:latest
    network_mode: host
    environment:
      - SHIM_INGRESS_PORT=9999
      - SHIM_NODE_TARGET=127.0.0.1:7777
      - RUST_LOG=info
    restart: always

  # Local Mesh Router (Head)
  head:
    image: alh477/mesh-head:latest
    network_mode: host
    restart: always

  # Local GPU Worker (Inference)
  worker:
    image: alh477/mesh-worker:latest
    network_mode: host
    # Pointing to the internal container path /models/...
    command: [
      "python3", "/bin/worker_node.py", 
      "--head-ip", "127.0.0.1",
      "--model-path", "/models/my_model.safetensors"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      # Map your host 'local-models' dir to container '/models'
      # Ensure you place your .safetensors file here
      - ./local-models:/models
      # Cache for HF models (if needed)
      - ./model-cache:/data/huggingface
    restart: always
