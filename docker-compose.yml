version: '3.8'

services:
  # Official Shim from Docker Hub
  shim:
    image: alh477/dcf-shim:latest
    network_mode: host
    environment:
      - SHIM_INGRESS_PORT=9999
      - SHIM_NODE_TARGET=127.0.0.1:7777
    restart: always

  # Local Router (Head)
  head:
    image: alh477/mesh-head:latest
    network_mode: host
    restart: always

  # Worker A: NVIDIA GPU
  worker-nvidia:
    image: alh477/mesh-worker-nvidia:latest
    network_mode: host
    command: ["python3", "/bin/worker_node.py", "--head-ip", "127.0.0.1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ./model-cache:/data/huggingface

  # Worker B: CPU / Hardware Agnostic
  # Runs on standard RAM/CPU (Slower, but universal compatibility)
  worker-cpu:
    image: alh477/mesh-worker-cpu:latest
    network_mode: host
    command: ["python3", "/bin/worker_node.py", "--head-ip", "127.0.0.1"]
    environment:
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ./model-cache:/data/huggingface
